<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmO2 Sci-Analyzer v19.2</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; max-width: 1400px; margin: 0 auto; padding: 20px; background: #f8f9fa; color: #212529; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #dee2e6; height: 100%; display: flex; flex-direction: column; margin-bottom: 20px; }
        h1 { color: #0d6efd; text-align: center; margin-bottom: 5px; font-weight: 800; }
        h3 { border-bottom: 2px solid #f1f3f5; padding-bottom: 10px; margin-bottom: 15px; color: #495057; font-size: 1.1em; font-weight: 700; }
        .subtitle { text-align: center; color: #6c757d; margin-bottom: 30px; font-size: 0.95em; }
        
        .controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .split-slider-box { grid-column: 1 / -1; background: #e7f1ff; padding: 15px; border-radius: 8px; border: 1px solid #b6d4fe; }
        
        /* Grid Layouts */
        .charts-main { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        .charts-classic { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        @media (max-width: 1100px) { 
            .charts-main, .charts-classic, .stats-grid { grid-template-columns: 1fr; } 
        }

        label { display: block; font-weight: 700; font-size: 0.75em; margin-bottom: 5px; color: #495057; text-transform: uppercase; letter-spacing: 0.5px; }
        select, input { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-family: inherit; font-size: 0.9em; box-sizing: border-box; }
        input[type=range] { padding: 0; }
        
        .file-box { border: 2px dashed #adb5bd; padding: 15px; text-align: center; border-radius: 8px; background: #e9ecef; cursor: pointer; display: flex; flex-direction: column; justify-content: center; height: 100%; }
        
        .btn-primary { background: #0d6efd; color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; margin-top: 10px; transition: 0.2s; }
        .btn-primary:hover { background: #0b5ed7; transform: translateY(-1px); }
        .btn-primary:disabled { background: #6c757d; cursor: not-allowed; transform: none; }

        .btn-pdf { background: #dc3545; color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; margin-top: 10px; display:none; }
        .btn-pdf:hover { background: #bb2d3b; }
        .btn-pdf:disabled { background: #6c757d; cursor: wait; }

        table { width: 100%; border-collapse: collapse; font-size: 0.85em; margin-top: auto; }
        th, td { padding: 8px 10px; text-align: center; border-bottom: 1px solid #dee2e6; }
        th { background: #f8f9fa; color: #495057; font-weight: 700; }
        .bias-high { color: #dc3545; font-weight: 800; background: #fff5f5; }
        .model-winner { background-color: #d1e7dd; font-weight: bold; color: #0f5132; }
        .method-novel { color: #0d6efd; font-weight: bold; }
        .method-classic { color: #6c757d; font-style: italic; }
        
        .warning-box { background: #fff3cd; color: #856404; padding: 15px; border-radius: 6px; margin-bottom: 15px; font-size: 0.9em; display: none; border: 1px solid #ffeeba; }
        .loading { display: none; background: #fff3cd; color: #856404; padding: 15px; border-radius: 6px; text-align: center; margin-top: 15px; border: 1px solid #ffeeba; }
        .error-msg { display: none; background: #f8d7da; color: #842029; padding: 15px; border-radius: 6px; margin-top: 15px; border: 1px solid #f5c2c7; }
        
        /* PDF Specific Styles */
        .pdf-footer { display: none; text-align: center; font-size: 0.7em; color: #adb5bd; margin-top: 20px; }
        
        /* When this class is added, layout becomes linear for PDF generation */
        .pdf-mode .charts-main, 
        .pdf-mode .charts-classic, 
        .pdf-mode .stats-grid { 
            display: block !important; /* Stack charts vertically */
        }
        
        .pdf-mode .card {
            page-break-after: always !important; /* Force new page after each card */
            break-after: page !important;
            margin-bottom: 0 !important; /* Remove margin as break handles spacing */
            border: none !important; /* Cleaner look */
            box-shadow: none !important;
        }
        
        .pdf-mode .card:last-child {
            page-break-after: auto !important;
        }
    </style>

    <script>
        function downloadPDF() {
            window.scrollTo(0, 0);
            
            const element = document.getElementById('results_area');
            const footer = document.getElementById('pdf_footer');
            
            // 1. Enter PDF Mode (Linear Layout)
            element.classList.add('pdf-mode');
            footer.style.display = 'block';

            const opt = {
                margin: 0.5, 
                filename: 'SmO2_Report.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true, 
                    scrollY: 0
                },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' },
                // Allow CSS to control page breaks
                pagebreak: { mode: ['css', 'legacy'] } 
            };
            
            const btn = document.getElementById('btn_pdf');
            const originalText = btn.innerText;
            btn.innerText = "‚è≥ Generating Report...";
            btn.disabled = true;
            
            html2pdf().set(opt).from(element).save().then(() => {
                // 2. Exit PDF Mode (Restore Grid)
                element.classList.remove('pdf-mode');
                footer.style.display = 'none';
                btn.innerText = originalText;
                btn.disabled = false;
            });
        }
    </script>
</head>
<body>

    <div class="card" style="margin-bottom: 25px;">
        <h1>ü©∏ SmO2 Sci-Analyzer v19.2</h1>
        <p class="subtitle">Top-3 Parsimony ‚Ä¢ Dual Dmax ‚Ä¢ LTP ‚Ä¢ PDF (One Plot/Page)</p>

        <div class="controls-grid">
            <div class="file-box" style="grid-row: span 2;">
                <label for="file_upload" style="cursor:pointer; margin:0;">üìÇ Upload Excel/CSV</label>
                <input type="file" id="file_upload" accept=".csv, .xlsx, .xls" style="display:block; margin-top:10px; width:90%;">
            </div>
            
            <div><label>1. Subject</label><select id="subject_select" disabled><option>-</option></select></div>
            <div><label>2. Load Unit</label>
                <select id="load_unit">
                    <option value="W" selected>Watts (W)</option>
                    <option value="km/h">Speed (km/h)</option>
                </select>
            </div>
            
            <div><label>3. Start Load</label>
                <input type="number" id="start_load" value="100" placeholder="100">
            </div>
            <div><label>4. Increment</label>
                <input type="number" id="load_inc" value="25" placeholder="25">
            </div>
            <div><label>5. Stage Dur (min)</label>
                <input type="number" id="stage_dur" value="1" placeholder="1">
            </div>
            
            <div class="split-slider-box">
                <label>Threshold Search Split: <span id="split_val">50</span>% Time</label>
                <input type="range" id="split_pct" min="20" max="80" value="50" oninput="document.getElementById('split_val').innerText = this.value">
                <div style="font-size:0.75em; color:#495057; margin-top:5px;">
                    Adjusts the search boundary for <b>Dual Dmax</b>.
                </div>
            </div>

             <div><label>6. Outlier Z</label>
                <select id="sensitivity">
                    <option value="2.5" selected>Standard (2.5)</option>
                    <option value="100">OFF</option>
                </select>
            </div>
        </div>

        <button id="btn_run" class="btn-primary" disabled>RUN DIAGNOSTICS</button>
        <button id="btn_pdf" class="btn-pdf" onclick="downloadPDF()">üì• DOWNLOAD PDF REPORT</button>
        
        <div id="loader" class="loading">
            ‚è≥ <b>Processing...</b> Reading File ‚Ä¢ Filtering Outliers ‚Ä¢ Calculating Models
        </div>
        <div id="error_box" class="error-msg"></div>
    </div>

    <div id="results_area" style="display:none;">
        
        <div class="warning-box" id="warn_msg"></div>

        <div class="charts-main">
            <div class="card">
                <h3>üìà Best Fit (Parsimony Corrected)</h3>
                <div id="plot_main"></div>
            </div>
            <div class="card">
                <h3>‚ü≥ Rate of Change (Smoothed)</h3>
                <div id="plot_derivative"></div>
            </div>
        </div>

        <div class="charts-classic">
            <div class="card">
                <h3>3-Segment LTP (on Fit)</h3>
                <div id="plot_seg"></div>
            </div>
            <div class="card">
                <h3>Dual Dmax (Split)</h3>
                <div id="plot_dmax"></div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="card">
                <h3 style="color:#0d6efd;">High Resolution (1s)</h3>
                <div id="stats_1s"></div>
            </div>
            <div class="card">
                <h3 style="color:#dc3545;">Averaged (5s)</h3>
                <div id="stats_5s"></div>
            </div>
        </div>
        
        <div class="card">
            <h3>‚öñÔ∏è Bias Analysis</h3>
            <div id="bias_table"></div>
        </div>
        
        <div id="pdf_footer" class="pdf-footer">Generated by SmO2 Sci-Analyzer v19.2</div>
    </div>

    <py-config>
        packages = ["pandas", "numpy", "scipy", "matplotlib", "openpyxl", "xlrd"]
    </py-config>

    <script type="py">
        import asyncio
        import pandas as pd
        import numpy as np
        import matplotlib.pyplot as plt
        import warnings
        from scipy.optimize import curve_fit, OptimizeWarning
        from js import document, Uint8Array
        from pyodide.ffi import create_proxy
        from pyscript import display
        import io

        warnings.simplefilter("ignore")

        df_global = None

        # --- WORKLOAD ---
        def get_workload(t_sec, start, inc, dur_min):
            if dur_min <= 0: return start
            if dur_min <= 1.0: 
                t_min = t_sec / 60.0
                return start + (t_min / dur_min) * inc
            else: 
                stage_idx = np.floor(t_sec / (dur_min * 60.0))
                return start + stage_idx * inc

        # --- MODELS ---
        def linear_model(x, a, b): return a * x + b
        def linear_deriv(x, a, b): return np.full_like(x, a)

        def cubic_model(x, a, b, c, d): return a*x**3 + b*x**2 + c*x + d
        def cubic_deriv(x, a, b, c, d): return 3*a*x**2 + 2*b*x + c

        def sigmoid_model(x, L, x0, k, b):
            arg = np.clip(k * (x - x0), -50, 50)
            return b - L / (1 + np.exp(-arg))
        
        def sigmoid_deriv(x, L, x0, k, b):
            arg = np.clip(k * (x - x0), -50, 50)
            ex = np.exp(-arg)
            return -(L * k * ex) / (1 + ex)**2

        def sine_model(x, A, omega, phi, offset):
            return A * np.sin(omega * x + phi) + offset

        def calc_stats(y_true, y_pred, k):
            ss_res = np.sum((y_true - y_pred) ** 2)
            ss_tot = np.sum((y_true - np.mean(y_true)) ** 2)
            r2 = 1 - (ss_res / ss_tot) if ss_tot != 0 else 0.0
            n = len(y_true)
            aic = n * np.log(ss_res/n + 1e-9) + 2*k
            return r2, aic

        # --- CLASSIC ALGORITHMS ---
        def get_3seg_ltp_smooth(x, y_smooth):
            n = len(x)
            if n < 20: return None
            step = 1 if n < 150 else int(n / 60)
            min_pts = 5
            best_sse = np.inf
            best_i, best_j = -1, -1
            for i in range(min_pts, n - 2*min_pts, step):
                for j in range(i + min_pts, n - min_pts, step):
                    p1 = np.polyfit(x[:i], y_smooth[:i], 1)
                    p2 = np.polyfit(x[i:j], y_smooth[i:j], 1)
                    p3 = np.polyfit(x[j:], y_smooth[j:], 1)
                    sse = np.sum((y_smooth[:i]-np.polyval(p1, x[:i]))**2) + \
                          np.sum((y_smooth[i:j]-np.polyval(p2, x[i:j]))**2) + \
                          np.sum((y_smooth[j:]-np.polyval(p3, x[j:]))**2)
                    if sse < best_sse:
                        best_sse = sse; best_i = i; best_j = j
            if best_i == -1: return None
            return {
                'bp1': x[best_i], 'bp2': x[best_j],
                'x1': x[:best_i], 'y1': np.polyval(np.polyfit(x[:best_i], y_smooth[:best_i], 1), x[:best_i]),
                'x2': x[best_i:best_j], 'y2': np.polyval(np.polyfit(x[best_i:best_j], y_smooth[best_i:best_j], 1), x[best_i:best_j]),
                'x3': x[best_j:], 'y3': np.polyval(np.polyfit(x[best_j:], y_smooth[best_j:], 1), x[best_j:])
            }

        def calc_single_dmax_smooth(x, y_smooth):
            try:
                x1, y1, x2, y2 = x[0], y_smooth[0], x[-1], y_smooth[-1]
                denom = np.sqrt((y2-y1)**2 + (x2-x1)**2)
                dists = np.abs((y2-y1)*x - (x2-x1)*y_smooth + x2*y1 - y2*x1) / denom
                idx = np.argmax(dists)
                return x[idx], y_smooth, ([x1, x2], [y1, y2])
            except: return None, None, None

        def get_dual_metrics_smooth(x, y_smooth, split_idx):
            # DMAX ONLY (Hinge Removed)
            if split_idx < 5: split_idx = 5
            if split_idx > len(x) - 5: split_idx = len(x) - 5

            x1, y1 = x[:split_idx], y_smooth[:split_idx]
            dmax1, _, chord1 = calc_single_dmax_smooth(x1, y1)

            x2, y2 = x[split_idx:], y_smooth[split_idx:]
            dmax2, _, chord2 = calc_single_dmax_smooth(x2, y2)

            return {
                'dmax': {'t1': dmax1, 't2': dmax2, 'c1': chord1, 'c2': chord2}
            }

        # --- PROCESSOR ---
        def process_curve(x, y, z_thresh, load_params, unit, split_pct):
            start, inc, dur = load_params
            
            # 1. OUTLIER
            x_c, y_c, x_o, y_o = x, y, [], []
            points_removed = 0
            if len(y) > 15:
                try:
                    p = np.poly1d(np.polyfit(x, y, 2))
                    resid = np.abs(y - p(x))
                    mad = np.median(resid)
                    sigma = 1.4826 * mad if mad > 1e-9 else 1e-9
                    mask = (resid / sigma) < z_thresh
                    x_c, y_c = x[mask], y[mask]
                    x_o, y_o = x[~mask], y[~mask]
                    points_removed = len(x_o)
                except: pass
            
            if len(x_c) < 15: return {'error': 'Insufficient data'}

            # 2. COMPETITION
            models = {}
            try:
                p, _ = curve_fit(linear_model, x_c, y_c)
                yp = linear_model(x_c, *p)
                r2, aic = calc_stats(y_c, yp, 2)
                models['Linear'] = {'aic': aic, 'r2': r2, 'p': p, 'yp': yp}
            except: models['Linear'] = {'aic': 1e9, 'r2':0}
            try:
                p, _ = curve_fit(cubic_model, x_c, y_c)
                yp = cubic_model(x_c, *p)
                r2, aic = calc_stats(y_c, yp, 4)
                models['Cubic'] = {'aic': aic, 'r2': r2, 'p': p, 'yp': yp}
            except: models['Cubic'] = {'aic': 1e9, 'r2':0}
            try:
                b_g=np.max(y_c); L_g=b_g-np.min(y_c); x0_g=np.mean(x_c)
                p, _ = curve_fit(sigmoid_model, x_c, y_c, p0=[L_g, x0_g, 0.1, b_g], maxfev=10000)
                yp = sigmoid_model(x_c, *p)
                r2, aic = calc_stats(y_c, yp, 4)
                models['Sigmoid'] = {'aic': aic, 'r2': r2, 'p': p, 'yp': yp}
            except: models['Sigmoid'] = {'aic': 1e9, 'r2':0}
            try:
                guess_freq = 2 * np.pi / (x_c[-1]-x_c[0]) * 3
                p, _ = curve_fit(sine_model, x_c, y_c, p0=[(max(y_c)-min(y_c))/2, guess_freq, 0, np.mean(y_c)], maxfev=5000)
                yp = sine_model(x_c, *p)
                r2, aic = calc_stats(y_c, yp, 4)
                models['Sine'] = {'aic': aic, 'r2': r2, 'p': p, 'yp': yp}
            except: models['Sine'] = {'aic': 1e9, 'r2':0}

            # 3. SELECTION (TOP 3)
            sorted_models = sorted(models.items(), key=lambda item: item[1]['aic'])
            best_name = sorted_models[0][0]
            warnings_list = []
            
            # Complexity: Linear < Cubic < Sigmoid < Sine
            complexity = {'Linear': 1, 'Cubic': 2, 'Sigmoid': 3, 'Sine': 4}
            
            if best_name == 'Sine':
                warnings_list.append("Oscillatory/Wavy Pattern. Downgrading to Linear.")
                best_name = 'Linear'
            
            else:
                candidates = sorted_models[:3]
                candidates.sort(key=lambda x: complexity[x[0]]) # Simplest first
                
                final_choice = best_name
                
                for name, model in candidates:
                    if complexity[name] < complexity[best_name]:
                        y_best = models[best_name]['yp']
                        y_simple = model['yp']
                        
                        rmse_diff = np.sqrt(np.mean((y_best - y_simple)**2))
                        data_range = np.max(y_c) - np.min(y_c)
                        
                        if rmse_diff < (0.03 * data_range):
                            warnings_list.append(f"Simplicity Check: Switched from {best_name} to {name}.")
                            final_choice = name
                            break 
                
                best_name = final_choice

            best = models[best_name]
            y_smooth = best['yp'] 
            
            if best_name == 'Linear':
                warnings_list.append("Linear Model Selected. Thresholds detection not possible.")
            if best['r2'] < 0.85: warnings_list.append(f"Low Fit Quality (R¬≤ = {best['r2']:.2f}).")
            if points_removed > 0: warnings_list.append(f"Outlier Removal: {points_removed} points excluded.")

            # 4. THRESHOLDS
            thresh_novel = {}
            dy = np.zeros_like(x_c)
            
            if best_name == 'Linear':
                dy = linear_deriv(x_c, *best['p'])
            elif best_name == 'Cubic':
                dy = cubic_deriv(x_c, *best['p'])
                a, b, c, d = best['p']
                if a != 0:
                    td2 = -b / (3*a)
                    if min(x_c) < td2 < max(x_c): 
                        thresh_novel['TD2'] = td2
                        delta = (2*b)**2 - 4*(3*a)*c
                        if delta >= 0:
                            roots = [(-2*b + np.sqrt(delta))/(6*a), (-2*b - np.sqrt(delta))/(6*a)]
                            valid_roots = [r for r in roots if min(x_c) < r < td2]
                            if valid_roots: thresh_novel['TD1'] = max(valid_roots)
            elif best_name == 'Sigmoid':
                dy = sigmoid_deriv(x_c, *best['p'])
                L, x0, k, b = best['p']
                td2 = x0
                td1 = x0 - (1.317/k)
                thresh_novel['TD2'] = td2
                if min(x_c) < td1 < td2: thresh_novel['TD1'] = td1

            def get_wl(t): return get_workload(t, start, inc, dur)
            thresh_novel_w = {k: (t, get_wl(t)) for k,t in thresh_novel.items()}

            split_idx = int(len(x_c) * (split_pct / 100))
            dual = get_dual_metrics_smooth(x_c, y_smooth, split_idx)
            cl_ltp = get_3seg_ltp_smooth(x_c, y_smooth)

            thresh_cl_w = {}
            if cl_ltp:
                thresh_cl_w['LTP1'] = (cl_ltp['bp1'], get_wl(cl_ltp['bp1']))
                thresh_cl_w['LTP2'] = (cl_ltp['bp2'], get_wl(cl_ltp['bp2']))
            
            if dual['dmax']['t1']: thresh_cl_w['Dmax1'] = (dual['dmax']['t1'], get_wl(dual['dmax']['t1']))
            if dual['dmax']['t2']: thresh_cl_w['Dmax2'] = (dual['dmax']['t2'], get_wl(dual['dmax']['t2']))

            return {
                'x': x_c, 'y': y_c, 'best': best, 'best_name': best_name, 'models': models,
                'x_o': x_o, 'y_o': y_o, 'warnings': warnings_list,
                'thresh_novel': thresh_novel_w, 'thresh_cl': thresh_cl_w,
                'cl_ltp': cl_ltp, 'dual': dual,
                'derivative': dy, 'split_time': x_c[split_idx], 'y_smooth': y_smooth
            }

        async def load_file(event):
            try:
                document.getElementById("loader").style.display = "block"
                document.getElementById("error_box").style.display = "none"
                document.getElementById("btn_pdf").style.display = "none"
                
                global df_global
                f = event.target.files.item(0)
                if not f: return
                buf = await f.arrayBuffer()
                
                # Robust Conversion using Uint8Array
                js_arr = Uint8Array.new(buf)
                data_bytes = bytearray(js_arr.to_py()) 
                data = io.BytesIO(data_bytes)
                
                fname = f.name.lower()
                
                if fname.endswith('.csv'): 
                    try: df_global = pd.read_csv(data, encoding='utf-8')
                    except: 
                        data.seek(0)
                        df_global = pd.read_csv(data, encoding='latin1')
                elif fname.endswith('.xls'): df_global = pd.read_excel(data, engine='xlrd')
                elif fname.endswith('.xlsx'): df_global = pd.read_excel(data, engine='openpyxl')
                else: raise ValueError("Unsupported file format")
                
                sel = document.getElementById("subject_select"); sel.innerHTML = ""
                for c in df_global.columns[1:]:
                    opt = document.createElement("option"); opt.text=c; opt.value=c; sel.appendChild(opt)
                sel.disabled=False; document.getElementById("btn_run").disabled=False
                document.getElementById("loader").style.display = "none"
                
            except Exception as e:
                document.getElementById("loader").style.display = "none"
                document.getElementById("error_box").innerText = f"Load Error: {str(e)}"
                document.getElementById("error_box").style.display = "block"

        async def run_analysis(event):
            try:
                document.getElementById("loader").style.display = "block"
                document.getElementById("results_area").style.display = "none"
                document.getElementById("warn_msg").style.display = "none"
                document.getElementById("error_box").style.display = "none"
                
                subj = document.getElementById("subject_select").value
                unit = document.getElementById("load_unit").value
                z_val = float(document.getElementById("sensitivity").value)
                split_pct = float(document.getElementById("split_pct").value)
                params = (float(document.getElementById("start_load").value),
                          float(document.getElementById("load_inc").value),
                          float(document.getElementById("stage_dur").value))

                t_col = df_global.columns[0]
                raw = df_global[[t_col, subj]].apply(pd.to_numeric, errors='coerce').dropna()
                t1, y1 = raw[t_col].values, raw[subj].values
                
                raw['bin'] = (raw[t_col]//5)*5
                df5 = raw.groupby('bin').mean().reset_index()
                t5, y5 = df5['bin'].values, df5[subj].values
                
                r1 = process_curve(t1, y1, z_val, params, unit, split_pct)
                r5 = process_curve(t5, y5, z_val, params, unit, split_pct)
                
                if 'error' in r1 or 'error' in r5: raise ValueError("Insufficient Data")

                if r1['warnings']:
                    document.getElementById("warn_msg").innerHTML = "<b>‚ö†Ô∏è Quality Alert:</b><br>" + "<br>".join(r1['warnings'])
                    document.getElementById("warn_msg").style.display = "block"

                # PLOT 1
                fig1, ax1 = plt.subplots(figsize=(8,5))
                ax1.scatter(r1['x'], r1['y'], s=10, c='#ced4da', label='Raw Data')
                if len(r1['x_o']) > 0: ax1.scatter(r1['x_o'], r1['y_o'], s=20, marker='x', c='red')
                ax1.plot(r1['x'], r1['y_smooth'], c='#0d6efd', lw=3, label=f"Fit: {r1['best_name']}")
                
                cols = ['#d63384', '#fd7e14']
                for i, (k, (t, w)) in enumerate(r1['thresh_novel'].items()):
                    ax1.axvline(t, c=cols[i%2], ls='--')
                    ax1.text(t, np.max(r1['y']), f"{k}\n{w:.0f}", c=cols[i%2], ha='right', fontsize=8)
                
                ax1.set_title(f"Model: {r1['best_name']} (AIC: {r1['best']['aic']:.0f})")
                ax1.legend()
                display(fig1, target="plot_main", append=False)
                plt.close(fig1)

                # PLOT 2
                fig2, ax2 = plt.subplots(figsize=(8,4))
                ax2.plot(r1['x'], r1['derivative'], c='#198754', lw=2)
                ax2.axhline(0, c='gray')
                for i, (k, (t, w)) in enumerate(r1['thresh_novel'].items()):
                    ax2.axvline(t, c=cols[i%2], ls='-', alpha=0.6)
                    ax2.text(t, 0, k, rotation=90, va='bottom', fontsize=8)
                display(fig2, target="plot_derivative", append=False)
                plt.close(fig2)

                # PLOT 3
                fs, axs = plt.subplots(figsize=(4,3))
                d = r1['cl_ltp']
                if d:
                    axs.plot(r1['x'], r1['y_smooth'], 'k-', alpha=0.15, lw=3)
                    axs.plot(d['x1'], d['y1'], 'b-'); axs.plot(d['x2'], d['y2'], 'g-'); axs.plot(d['x3'], d['y3'], 'orange')
                    axs.axvline(d['bp1'], c='r', ls='--'); axs.axvline(d['bp2'], c='r', ls='--')
                axs.set_title("3-Seg LTP"); display(fs, target="plot_seg", append=False)
                plt.close(fs)

                # PLOT 4
                fd, axd = plt.subplots(figsize=(4,3))
                d = r1['dual']['dmax']
                axd.plot(r1['x'], r1['y_smooth'], 'k-', alpha=0.2, lw=2)
                axd.axvline(r1['split_time'], c='gray', ls=':')
                if d['t1']:
                    axd.plot(d['c1'][0], d['c1'][1], 'g--')
                    axd.plot(d['t1'], np.interp(d['t1'], r1['x'], r1['y_smooth']), 'ro')
                if d['t2']:
                    axd.plot(d['c2'][0], d['c2'][1], 'g--')
                    axd.plot(d['t2'], np.interp(d['t2'], r1['x'], r1['y_smooth']), 'ro')
                axd.set_title("Dual Dmax"); display(fd, target="plot_dmax", append=False)
                plt.close(fd)

                # TABLES
                def make_stats_table(res):
                    h = f"<table class='table'><thead><tr><th>Model</th><th>AIC</th><th>R¬≤</th><th>Status</th></tr></thead><tbody>"
                    for m_name in ['Linear', 'Cubic', 'Sigmoid', 'Sine']:
                        if m_name in res['models']:
                            m = res['models'][m_name]
                            cls = "model-winner" if m_name == res['best_name'] else ""
                            status = "Selected" if m_name == res['best_name'] else "-"
                            h += f"<tr class='{cls}'><td>{m_name}</td><td>{m['aic']:.0f}</td><td>{m['r2']:.3f}</td><td>{status}</td></tr>"
                    
                    h += "<tr><td colspan='4' style='background:#f1f3f5; font-weight:bold; text-align:center;'>Thresholds</td></tr>"
                    h += f"<tr><th>Method</th><th>Name</th><th>Time</th><th>{unit}</th></tr>"
                    
                    for k,(t,w) in res['thresh_novel'].items():
                        h += f"<tr class='method-novel'><td>Model</td><td>{k}</td><td>{t:.0f}</td><td>{w:.0f}</td></tr>"
                    for k,(t,w) in res['thresh_cl'].items():
                        h += f"<tr class='method-classic'><td>Classic</td><td>{k}</td><td>{t:.0f}</td><td>{w:.0f}</td></tr>"
                    return h + "</tbody></table>"
                
                document.getElementById("stats_1s").innerHTML = make_stats_table(r1)
                document.getElementById("stats_5s").innerHTML = make_stats_table(r5)

                # BIAS
                bh = "<table class='table'><thead><tr><th>Method</th><th>Thresh</th><th>1s</th><th>5s</th><th>Bias</th></tr></thead><tbody>"
                keys = set(r1['thresh_novel']).intersection(r5['thresh_novel'])
                for k in keys:
                    t1, t2 = r1['thresh_novel'][k][0], r5['thresh_novel'][k][0]
                    d = t2-t1; c = "bias-high" if abs(d)>15 else ""
                    bh+=f"<tr><td class='method-novel'>Model</td><td>{k}</td><td>{t1:.0f}</td><td>{t2:.0f}</td><td class='{c}'>{d:+.1f}</td></tr>"
                
                for k in r1['thresh_cl'].keys():
                    if k in r5['thresh_cl']:
                        v1, v2 = r1['thresh_cl'][k], r5['thresh_cl'][k]
                        d = v2[0]-v1[0]; c = "bias-high" if abs(d)>15 else ""
                        bh+=f"<tr><td class='method-classic'>Classic</td><td>{k}</td><td>{v1[0]:.0f}</td><td>{v2[0]:.0f}</td><td class='{c}'>{d:+.1f}</td></tr>"

                document.getElementById("bias_table").innerHTML = bh + "</tbody></table>"
                document.getElementById("results_area").style.display = "block"
                document.getElementById("btn_pdf").style.display = "block"
                document.getElementById("loader").style.display = "none"

            except Exception as e:
                document.getElementById("loader").style.display = "none"
                document.getElementById("error_box").innerText = str(e)
                document.getElementById("error_box").style.display = "block"

        document.getElementById("file_upload").addEventListener("change", create_proxy(load_file))
        document.getElementById("btn_run").addEventListener("click", create_proxy(run_analysis))
    </script>
</body>
</html>
